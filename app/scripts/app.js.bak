'use strict';

var React = require('react');
var DateTimeField= require('react-bootstrap-datetimepicker');
var moment = require('moment');
var _ = require('underscore');

var AttendanceDetail = React.createClass({

  handleClick: function(e){
    e.preventDefault();
    this.props.handleClick();
  },

  render: function() {
    //console.log('CHECKED:', this.state.checked);
    //console.log(this.props.player.player_name + ' ATTENDED = ' + this.props.player.attended);

    var niceDate = moment(this.props.detail.date).format('DD. MMMM - HH:mm');    
    return (
        
      <tr>
        <td>                                      
          <a href={this.props.detail.seminarAttendance} onClick={this.handleClick}>{niceDate}</a>
        </td>
      </tr>            
             
    );
  }    
});

var AttendanceList = React.createClass({    
  handleClick: function(index) {
      this.props.changeAttendance(index);
  },

  render: function() {
    var rows = [];
    this.props.attendance.forEach(function(attendance, index) {
    //for (var i = 0; i < this.props.attendance.length; i++) {
      //console.log(attendance.date);
      rows.push(
        <AttendanceDetail 
          handleClick={this.handleClick.bind(this, index)}
          detail={attendance} 
          key={index}
          changeAttendance={this.changeAttendance}/>)
      }.bind(this));

    return (
      <div className="table-responsive">                
        <table className="table table-striped">
          <thead>
            <tr>                
              <th>Dagsetning</th>
            </tr>
          </thead>
          <tbody>
            {rows}
          </tbody>
        </table>                          
      </div>

    );
  }    
});

var PlayerDetail = React.createClass({
  
  getInitialState: function() {
    return {
      attended: this.props.attended
    }
  },
  

  handleChange: function(ssn) {
    //console.log(index);
    //console.log('index, attended', index, attended);
    /*
   var nextState = {
          ssn: this.state.player.ssn,
          attended: (this.state.player.ssn === ssn ? !this.state.player.attended : this.state.player.attended)
      };


    this.setState({player: nextState});
    console.log('this.state.player: ', this.state.player);
    */    
    var newAttended = !this.state.attended;
    this.setState({attended: newAttended});
    //var changedPlayer = {ssn: this.props.player.ssn, attended: newAttended};
    this.props.changePresence(ssn);

    //this.setState({player[attended]});
  },

  render: function() {
    //console.log(this.props.player);
  //console.log('ATTENDED detail:', this.state.attended);
    //console.log(this.state.checked);
    //console.log(this.props.attended);    
    //console.log(this.state.data[this.state.currentSeminar]);
    //console.log(this.props.player.player_name + ' ATTENDED: ' + this.props.player.attended);
    
    return (
        
      <tr>
        <td>
          <label>
            <input 
              type="checkbox"
              disabled={this.props.currentAttendance ? false:true}
              checked={this.state.attended}
              //defaultChecked={this.props.currentAttendance ? false:true} 
              onChange={this.handleChange} />
          </label>
        </td>
        <td>                                      
          {this.props.player.player_name}                 
        </td>
        <td>                                      
          {this.props.player.email}                 
        </td>
        <td>                                      
          {this.props.date}
        </td>
      </tr>            
             
    );
  }    
});

var PlayerList = React.createClass({
  
  getInitialState: function() {
    var attendance = _.findWhere(this.props.seminar.attendance, {id: this.props.currentAttendance});


    return {
      attendance: attendance,
      date: moment().format('YYYY-MM-DDTHH:mm:ss.SSS')

    }
  },

  changeDate: function(date) {    
    this.setState({ date: date });    
  },

  handleSave: function() {
    this.props.handleSave();
  },
  
  handleAdd: function(currentAttendance) {
    this.props.handleAdd(currentAttendance);
  },

  changePresence: function(ssn) {

    var newAttended = [];
    var attendance = this.state.attendance;

    console.log('ssn: ', ssn);


    this.state.attendance.attended.forEach(function(player, index) {
      
      if (player.ssn == ssn) {
        newAttended.push({ssn: ssn, attended: !(player.attended === 'true')});
      }

      else {
        newAttended.push({ssn: ssn, attended: player.attended});
      }
    });

    attendance.attended = newAttended;

    this.setState({attendance: attendance});
    

    //console.log(this.state.playersAttended);
    /*
    this.props.seminar[]playersAttended.forEach(function(player, i){      
      
      if (player.ssn === ssn) {
        //console.log('In playerlist: ', !player.attended, index);
        updatedPlayerAttendance.push({ssn: player.ssn, attended: !player.attended});
      }
      else {
       updatedPlayerAttendance.push({ssn: player.ssn, attended: player.attended}); 
      }
      
    });
    if (this.isMounted()) {
      this.setState({playersAttended: updatedPlayerAttendance});  
    }
    */
  },

  addAttendance: function() {
    //console.log(this.state.data[this.state.currentSeminar].players);
    var seminars = [];
    var attendance = {};
    var players = [];
    var temp = [];
    //console.log(moment().toISOString());
    //console.log(this.props.seminar.players);

    attendance.date = this.state.date;
    //attendance.seminar = this.props.seminar.seminar_id

    this.props.seminar.players.forEach(function(player, index) {      
      players.push(
        {
          ssn: player.ssn,
          attended: true
        });
    });
    
    
    console.log('attendance.date: ', attendance.date);
    console.log('this.state.date: ', this.state.date);
    attendance.attended = players;
    var url = 'http://localhost:1337/seminar/'+this.props.seminar.seminar_id+'/attendance';

    $.ajax({
      url: url,
      dataType: 'json',
      //contentType: 'application/json',
      method: 'POST',
      async: true,
      //processData: false,
      data: attendance,

      success: function(data) {
        //console.log('SUCCESS: ', data);   
        
        if (this.isMounted()) {
          console.log('RESPONSE:', data);          
          console.log('ATTENDANCE:', data.attendance.length -1);
          var lastItem = (data.attendance.length - 1);
          //console.log('ATTENDANCE:', lastItem.id);
          this.handleAdd(data.attendance[lastItem].id);
        }
        
      }.bind(this),
      error: function(xhr, status, err) {
        console.error(url, status, err.toString());
      }.bind(this)
    });  
    
  },
  saveAttendance: function() {
    //console.log('this.state.playersAttended: ', this.state.playersAttended);
    var newAttendance = {playersAttended: this.state.playersAttended};

    $.ajax({
      url: 'http://localhost:1337/attendance/'+this.props.currentAttendance.id,
      dataType: 'json',
      //contentType: 'application/json',
      method: 'PUT',
      async: true,
      //processData: false,
      data: newAttendance,

      success: function(data) {
        //console.log('SUCCESS: ', data);   
        
        if (this.isMounted()) {
          console.log('SUCCESS:', data);
          this.setState({playersAttended: data.playersAttended});
          
          //this.handleSave();         
        }
        
      }.bind(this),
      error: function(xhr, status, err) {
        console.error('http://localhost:1337/attendance/'+this.props.currentAttendance.id, status, err.toString());
      }.bind(this)
    });  
    
  },

  /*
  handleAttended: function(player) {
    this.setState({attended: player});
  },
  */
  render: function() {
    console.log('this.state.date: ', this.state.date);
    console.log(this.state.attendance);

    var players = [];  
    var playersAttended = [];  
    var currentAttendance = this.props.currentAttendance;
    /* this.state.date is undefined on mount so moment adds NOW as date */
    //var attendanceDate = moment(this.state.date).format('YYYY-MM-DDTHH:mm:ss.SSS');
    
    //console.log('attendanceDate: ', attendanceDate);
    if (currentAttendance) {
      console.log('currentAttendance: ',currentAttendance);
      
      var info = 'Fann enga m√¶tingu';
      //console.log(this.props.seminar.attendance.length);
      
      var allPlayers = this.props.players;
      //console.log(this.props.currentAttendance);
      //console.log(this.state.playersAttended);
      //console.log(this.props.currentAttendance);
      //console.log(this.props.currentAttendance);
      //console.log(this.props.currentAttendance);
      //console.log('this.props.seminar.attendance[this.props.currentAttendance]', this.props.seminar.attendance[this.props.currentAttendance]);
      //console.log(this.props.players);
      
      
      //console.log('findWhere: ', this.state.attendance);

      this.props.seminar.players.forEach(function(player) {
        this.state.attendance.attended.filter(function(a){
          //console.log(a);
          if (a.ssn == player.ssn) {
            var attended = (a.attended === 'true')
            console.log('attended: ', attended);
            //playersAttended.push({ssn: player.ssn, attended: (a.attended === 'true')});
            players.push(
              <PlayerDetail 
                //handleAttended={this.handleAttended} 
                //disabled={false}
                date={this.state.date}
                currentAttendance={this.props.currentAttendance}
                attended={attended}
                //readOnly={false} 
                //attended={player.attended}
                player={player} 
                key={player.ssn}
                changePresence={this.changePresence.bind(this, player.ssn)} />);            
          }           
        }.bind(this));
      }.bind(this));
      //console.log('players: ', players);
    }                

    else {
      console.log('this.props.currentAttendance: ', this.props.currentAttendance);
      this.props.seminar.players.forEach(function(player) {
        //console.log('player: ', player.ssn, player.attended);
        players.push(
          <PlayerDetail 
            //handleAttended={this.handleAttended} 
            //disabled={false}
            date={this.state.date}
            currentAttendance={this.props.currentAttendance}
            //readOnly={false} 
            //attended={player.attended}
            player={player} 
            key={player.ssn}
            changePresence={this.changePresence.bind(this, player.ssn)} />);
      }.bind(this)); 
    };



    return (  
      <div className="row">
        <div className="col-xs-12">
          
            
              <div className="row">
                <div className="col-xs-12 col-md-3"> 

                  <fieldset disabled={this.props.currentAttendance ? false:true}>
                    <DateTimeField 
                                   
                      inputFormat='D. MMM - h:mm' 
                      onChange={this.changeDate} 
                      
                      format="YYYY-MM-DDTHH:mm:ss.SSS"
                      dateTime={this.state.date} />
                  </fieldset>
                </div>
                <div className="col-xs-12 col-md-3">
                  <button 
                    type="button" 
                    disabled={this.props.currentAttendance ? true:false}
                    className="btn btn-primary btn-md btn-block" 
                    onClick={this.addAttendance}>N√Ω m√¶ting</button>
                </div>
              </div>
            
                                         
          <div className="row">
            <div className="col-xs-12">
              <div className="table-responsive">                
                <table className="table table-striped">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Nafn</th>
                      <th>S√≠mi</th>
                      <th>Netfang</th>
                    </tr>
                  </thead>
                  <tbody>
                    {players}
                  </tbody>
                </table>
                <button 
                  type="button" 
                  className="btn btn-success btn-lg btn-block"
                  disabled={this.props.currentAttendance ? false:true} 
                  onClick={this.saveAttendance}>Vista</button>
              </div> 
            </div>
          </div>                                 
        </div>
      </div>    
    );    
  }    
});

var Attendance = React.createClass({


  handleSave: function() {
    this.props.handleSave();
  },
  
  handleAdd: function(currentAttendance) {
    this.props.handleAdd(currentAttendance);
  },
  
  changePresence: function(player, attended) {
    this.props.changePresence(player, attended);
  },

  addAttendance: function() {
    //console.log(this.state.data[this.state.currentSeminar].players);
    var seminars = [];
    var attendance = {};
    var players = [];
    var temp = [];
    //console.log(moment().toISOString());
    //console.log(this.props.seminar.players);

    attendance.date = this.state.date;
    attendance.seminar = this.props.seminar.seminar_id

    this.props.seminar.players.forEach(function(player, index) {      
      players.push(
        {
          ssn: player.ssn,
          attended: player.attended
        });
    });
    
    

    attendance.playersAttended = players;

    $.ajax({
      url: 'http://localhost:1337/seminar/'+this.props.seminar.seminar_id+'/attendance/add',
      dataType: 'json',
      //contentType: 'application/json',
      method: 'POST',
      async: true,
      //processData: false,
      data: attendance,

      success: function(data) {
        //console.log('SUCCESS: ', data);   
        
        if (this.isMounted()) {
          //console.log('CURRENT:', this.props.seminar);
          this.handleAdd();
        }
        
      }.bind(this),
      error: function(xhr, status, err) {
        console.error("http://localhost:1337/attendance", status, err.toString());
      }.bind(this)
    });  
    
  },
  saveAttendance: function() {
    //console.log(this.state.data[this.state.currentSeminar].players);
    var seminars = [];
    var attendance = {};
    var players = [];
    var temp = [];
    //console.log(moment().toISOString());
    //console.log(this.props.seminar.players);
    attendance.date = this.state.date;
    attendance.seminar = this.props.seminar.seminar_id

    this.props.seminar.players.forEach(function(player, index) {      
      players.push(
        {
          ssn: player.ssn,
          attended: player.attended
        });
    });
    
    attendance.playersAttended = players;

    $.ajax({
      url: 'http://localhost:1337/seminar/'+this.props.seminar.seminar_id+'/attendance/add',
      dataType: 'json',
      //contentType: 'application/json',
      method: 'POST',
      async: true,
      //processData: false,
      data: attendance,

      success: function(data) {
        //console.log('SUCCESS: ', data);   
        
        if (this.isMounted()) {
          //console.log('CURRENT:', this.props.seminar);
          this.handleSave();         
        }
        
      }.bind(this),
      error: function(xhr, status, err) {
        console.error("http://localhost:1337/attendance", status, err.toString());
      }.bind(this)
    });  
    
  },

  /*
  handleAttended: function(player) {
    this.setState({attended: player});
  },
  */
  render: function() {
    var info = 'Fann enga m√¶tingu';
    console.log(this.props.currentAttendance);
    var players = [];
    var allPlayers = this.props.seminar.players;
    //console.log(this.props.currentAttendance);
    //console.log(this.props.currentAttendance);
    //console.log('this.props.seminar.attendance[this.props.currentAttendance]', this.props.seminar.attendance[this.props.currentAttendance]);
    //console.log('CURRENT ATTENDANCE: ', this.props.currentAttendance);
    //var currentAttendance = this.props.seminar.attendance[this.props.currentAttendance];
    return (  


        <div className="row">
          <div className="col-xs-12">             
            <PlayerList
              handleAdd={this.handleAdd}
              seminar={this.props.seminar}
              key={this.props.currentAttendance}                 
              currentAttendance={this.props.currentAttendance}/>                          
          </div>
        </div>

        );
    /*
    if (this.props.currentAttendance) {      
      var currentAttendance = this.props.seminar.attendance[this.props.currentAttendance];
      return (  


          <div className="row">
            <div className="col-xs-12">             
              <PlayerList
                //handleAttended={this.handleAttended}
                seminar={this.props.seminar}
                key={this.props.currentAttendance}                 
                currentAttendance={currentAttendance}/>                          
            </div>
          </div>
  
          );
    }

    else {
      return null
    };  
    */  
  }    
});

var Waiting = React.createClass({

    render: function() {

        return (
        <div className="alert alert-info">
          {this.props.info}
        </div>
        );
    }
});


var SeminarItem = React.createClass({
    handleClick: function(e){
      e.preventDefault();
      this.props.handleClick();
    },

    render: function() {
        var name = this.props.seminar.seminar_name;
        var players = this.props.seminar.players;

        return (
          <li className={this.props.isCurrent ? 'active' : null} role="presentation">
            <a href={this.props.seminar.seminar_id} onClick={this.handleClick}>{name}</a>
          </li>                
        );
    }
});


var SeminarNavigation = React.createClass({

  handleClick: function(index) {    
    this.props.changeSeminar(index);
  }, 

  render: function() {

  var seminars = [];
      this.props.seminarList.forEach(function(seminar, index) {
          seminars.push(
            <SeminarItem
              handleClick={this.handleClick.bind(this, index)}
              isCurrent={(this.props.currentSeminar === index)}
              seminar={seminar}
              key={seminar.seminar_id}
              changeSeminar={this.changeSeminar}/>)
      }.bind(this));
   
   
  
    return (
        <ul className="nav nav-tabs">{seminars}</ul>      
    );
  }
});

var App = React.createClass({

  getInitialState: function () { 
    
    return {
        seminars: [],
        data: [],
        currentSeminar: 0,
        currentAttendance: null        
    };
  },

  getSeminars: function(currentAttendance) {
    $.ajax({      
          url: this.props.url,
          cache: true,
          success: function(data) {
            if (this.isMounted()) {
              /*
              data.forEach(function(seminar, index) {
                for (var i = 0; i < seminar.players.length; i++) {              
                  seminar.players[i].attended = true;
                  //console.log(seminar.players[i]);              
                }
              }); 
              */             
              this.setState({ data: data});
              //console.log('attendanceLength: ',attendanceLength);
              
              if (currentAttendance) {
                this.setState({currentAttendance: currentAttendance})
              }
            }
          }.bind(this),

          error: function(xhr, status, err) {
            console.error(this.props.url, status, err.toString());
          }.bind(this)
        });
  },

  componentDidMount: function() {    
    this.getSeminars();
    
  },
  

  changePresence: function(player, attended) {
    console.log(player, attended);
  },
   
  handleAdd: function(currentAttendance) {
    this.getSeminars(currentAttendance);    
  },

  changeSeminar: function(index) {
    this.setState({ currentSeminar: index });
    this.setState({ currentAttendance: null });    
  },

  changeAttendance: function(index) {
    this.setState({ currentAttendance: index });
  },

  render: function(){
    //console.log('EVENT DATE: ', this.state.date);
    var info = 'S√¶ki g√∂gn.....'
    //console.log('Current seminar: ', this.state.currentSeminar)
    console.log(this.state.currentAttendance);
    if (this.state.data.length === 0) {
      return ( <Waiting info={info}/> );
    }
    else {
      return(
        <div>
          <div className="col-xs-12 col-md-9">
            <div className="row">
              <div className="col-xs-12">            
                <SeminarNavigation
                  currentSeminar={this.state.currentSeminar}
                  seminarList={this.state.data}
                  changeSeminar={this.changeSeminar} />
              </div>
            </div>                      
            <div className="row">
              <div className="col-xs-12">
                <Attendance 
                  handleAdd={this.handleAdd}                  
                  seminar={this.state.data[this.state.currentSeminar]}
                  changePresence={this.changePresence} 
                  currentAttendance={this.state.currentAttendance}/>
              </div>
            </div>         
          </div>
          <div className="col-xs-12 col-md-3" >
            <AttendanceList 
              attendance={this.state.data[this.state.currentSeminar].attendance}
              changeAttendance={this.changeAttendance} />
          </div>
        </div>  
      );
    }  
  }
});


React.render(<App url="http://localhost:1337/seminar" />, document.getElementById('app') );
//React.render(<DateTimeField />, document.getElementById('demo') );